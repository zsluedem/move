<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Global Storage Operators - The Move Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Move book maintained by the Move core team.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="modules-and-scripts.html"><strong aria-hidden="true">1.</strong> Modules and Scripts</a></li><li class="chapter-item expanded "><a href="creating-coins.html"><strong aria-hidden="true">2.</strong> Move Tutorial</a></li><li class="chapter-item expanded "><a href="integers.html"><strong aria-hidden="true">3.</strong> Integers</a></li><li class="chapter-item expanded "><a href="bool.html"><strong aria-hidden="true">4.</strong> Bool</a></li><li class="chapter-item expanded "><a href="address.html"><strong aria-hidden="true">5.</strong> Address</a></li><li class="chapter-item expanded "><a href="vector.html"><strong aria-hidden="true">6.</strong> Vector</a></li><li class="chapter-item expanded "><a href="signer.html"><strong aria-hidden="true">7.</strong> Signer</a></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">8.</strong> References</a></li><li class="chapter-item expanded "><a href="tuples.html"><strong aria-hidden="true">9.</strong> Tuples and Unit</a></li><li class="chapter-item expanded "><a href="variables.html"><strong aria-hidden="true">10.</strong> Local Variables and Scopes</a></li><li class="chapter-item expanded "><a href="equality.html"><strong aria-hidden="true">11.</strong> Equality</a></li><li class="chapter-item expanded "><a href="abort-and-assert.html"><strong aria-hidden="true">12.</strong> Abort and Assert</a></li><li class="chapter-item expanded "><a href="conditionals.html"><strong aria-hidden="true">13.</strong> Conditionals</a></li><li class="chapter-item expanded "><a href="loops.html"><strong aria-hidden="true">14.</strong> While and Loop</a></li><li class="chapter-item expanded "><a href="functions.html"><strong aria-hidden="true">15.</strong> Functions</a></li><li class="chapter-item expanded "><a href="structs-and-resources.html"><strong aria-hidden="true">16.</strong> Structs and Resources</a></li><li class="chapter-item expanded "><a href="constants.html"><strong aria-hidden="true">17.</strong> Constants</a></li><li class="chapter-item expanded "><a href="generics.html"><strong aria-hidden="true">18.</strong> Generics</a></li><li class="chapter-item expanded "><a href="abilities.html"><strong aria-hidden="true">19.</strong> Type Abilities</a></li><li class="chapter-item expanded "><a href="uses.html"><strong aria-hidden="true">20.</strong> Uses and Aliases</a></li><li class="chapter-item expanded "><a href="friends.html"><strong aria-hidden="true">21.</strong> Friends</a></li><li class="chapter-item expanded "><a href="packages.html"><strong aria-hidden="true">22.</strong> Packages</a></li><li class="chapter-item expanded "><a href="unit-testing.html"><strong aria-hidden="true">23.</strong> Unit Tests</a></li><li class="chapter-item expanded "><a href="global-storage-structure.html"><strong aria-hidden="true">24.</strong> Global Storage Structure</a></li><li class="chapter-item expanded "><a href="global-storage-operators.html" class="active"><strong aria-hidden="true">25.</strong> Global Storage Operators</a></li><li class="chapter-item expanded "><a href="standard-library.html"><strong aria-hidden="true">26.</strong> Standard Library</a></li><li class="chapter-item expanded "><a href="coding-conventions.html"><strong aria-hidden="true">27.</strong> Coding Conventions</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Move Book</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/move-language/move" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/move-language/move/edit/main/language/documentation/book/src/global-storage-operators.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="global-storage---operators"><a class="header" href="#global-storage---operators">Global Storage - Operators</a></h1>
<p>Move programs can create, delete, and update <a href="./structs-and-resources.html">resources</a> in global storage using the following five instructions:</p>
<table><thead><tr><th>Operation</th><th>Description</th><th>Aborts?</th></tr></thead><tbody>
<tr><td><code>move_to&lt;T&gt;(&amp;signer,T)</code></td><td>Publish <code>T</code> under <code>signer.address</code></td><td>If <code>signer.address</code> already holds a <code>T</code></td></tr>
<tr><td><code>move_from&lt;T&gt;(address): T</code></td><td>Remove <code>T</code> from <code>address</code> and return it</td><td>If <code>address</code> does not hold a <code>T</code></td></tr>
<tr><td><code>borrow_global_mut&lt;T&gt;(address): &amp;mut T</code></td><td>Return a mutable reference to the <code>T</code> stored under <code>address</code></td><td>If <code>address</code> does not hold a <code>T</code></td></tr>
<tr><td><code>borrow_global&lt;T&gt;(address): &amp;T</code></td><td>Return an immutable reference to the <code>T</code> stored under <code>address</code></td><td>If <code>address</code> does not hold a <code>T</code></td></tr>
<tr><td><code>exists&lt;T&gt;(address): bool</code></td><td>Return <code>true</code> if a <code>T</code> is stored under <code>address</code></td><td>Never</td></tr>
</tbody></table>
<p>Each of these instructions is parameterized by a type <code>T</code> with the <a href="./abilities.html"><code>key</code> ability</a>. However, each type <code>T</code> <em>must be declared in the current module</em>. This ensures that a resource can only be manipulated via the API exposed by its defining module. The instructions also take either an <a href="./address.html"><code>address</code></a> or <a href="./signer.html"><code>&amp;signer</code></a> representing the account address where the resource of type <code>T</code> is stored.</p>
<h2 id="references-to-resources"><a class="header" href="#references-to-resources">References to resources</a></h2>
<p>References to global resources returned by <code>borrow_global</code> or <code>borrow_global_mut</code> mostly behave like references to local storage: they can be extended, read, and written using ordinary <a href="./references.html">reference operators</a> and passed as arguments to other function. However, there is one important difference between local and global references: <strong>a function cannot return a reference that points into global storage</strong>. For example, these two functions will each fail to compile:</p>
<pre><code class="language-move">struct R has key { f: u64 }
// will not compile
fun ret_direct_resource_ref_bad(a: address): &amp;R {
    borrow_global&lt;R&gt;(a) // error!
}
// also will not compile
fun ret_resource_field_ref_bad(a: address): &amp;u64 {
    &amp;borrow_global&lt;R&gt;(a).f // error!
}
</code></pre>
<p>Move must enforce this restriction to guarantee absence of dangling references to global storage. <a href="#reference-safety-for-global-resources">This</a> section contains much more detail for the interested reader.</p>
<h2 id="global-storage-operators-with-generics"><a class="header" href="#global-storage-operators-with-generics">Global storage operators with generics</a></h2>
<p>Global storage operations can be applied to generic resources with both instantiated and uninstantiated generic type parameters:</p>
<pre><code class="language-move">struct Container&lt;T&gt; has key { t: T }

// Publish a Container storing a type T of the caller's choosing
fun publish_generic_container&lt;T&gt;(account: &amp;signer, t: T) {
    move_to&lt;Container&lt;T&gt;&gt;(account, Container { t })
}

/// Publish a container storing a u64
fun publish_instantiated_generic_container(account: &amp;signer, t: u64) {
    move_to&lt;Container&lt;u64&gt;&gt;(account, Container { t })
}
</code></pre>
<p>The ability to index into global storage via a type parameter chosen at runtime is a powerful Move feature known as <em>storage polymorphism</em>. For more on the design patterns enabled by this feature, see <a href="./generics.html">Move generics</a>.</p>
<h2 id="example-counter"><a class="header" href="#example-counter">Example: <code>Counter</code></a></h2>
<p>The simple <code>Counter</code> module below exercises each of the five global storage operators. The API exposed by this module allows:</p>
<ul>
<li>Anyone to publish a <code>Counter</code> resource under their account</li>
<li>Anyone to check if a <code>Counter</code> exists under any address</li>
<li>Anyone to read or increment the value of a <code>Counter</code> resource under any address</li>
<li>An account that stores a <code>Counter</code> resource to reset it to zero</li>
<li>An account that stores a <code>Counter</code> resource to remove and delete it</li>
</ul>
<pre><code class="language-move">address 0x42 {
module counter {
    use std::signer;

    /// Resource that wraps an integer counter
    struct Counter has key { i: u64 }

    /// Publish a `Counter` resource with value `i` under the given `account`
    public fun publish(account: &amp;signer, i: u64) {
      // &quot;Pack&quot; (create) a Counter resource. This is a privileged operation that
      // can only be done inside the module that declares the `Counter` resource
      move_to(account, Counter { i })
    }

    /// Read the value in the `Counter` resource stored at `addr`
    public fun get_count(addr: address): u64 acquires Counter {
        borrow_global&lt;Counter&gt;(addr).i
    }

    /// Increment the value of `addr`'s `Counter` resource
    public fun increment(addr: address) acquires Counter {
        let c_ref = &amp;mut borrow_global_mut&lt;Counter&gt;(addr).i;
        *c_ref = *c_ref + 1
    }

    /// Reset the value of `account`'s `Counter` to 0
    public fun reset(account: &amp;signer) acquires Counter {
        let c_ref = &amp;mut borrow_global_mut&lt;Counter&gt;(signer::address_of(account)).i;
        *c_ref = 0
    }

    /// Delete the `Counter` resource under `account` and return its value
    public fun delete(account: &amp;signer): u64 acquires Counter {
        // remove the Counter resource
        let c = move_from&lt;Counter&gt;(signer::address_of(account));
        // &quot;Unpack&quot; the `Counter` resource into its fields. This is a
        // privileged operation that can only be done inside the module
        // that declares the `Counter` resource
        let Counter { i } = c;
        i
    }

    /// Return `true` if `addr` contains a `Counter` resource
    public fun exists(addr: address): bool {
        exists&lt;Counter&gt;(addr)
    }
}
}
</code></pre>
<h2 id="annotating-functions-with-acquires"><a class="header" href="#annotating-functions-with-acquires">Annotating functions with <code>acquires</code></a></h2>
<p>In the <code>counter</code> example, you might have noticed that the <code>get_count</code>, <code>increment</code>, <code>reset</code>, and <code>delete</code> functions are annotated with <code>acquires Counter</code>. A Move function <code>m::f</code> must be annotated with <code>acquires T</code> if and only if:</p>
<ul>
<li>The body of <code>m::f</code> contains a <code>move_from&lt;T&gt;</code>, <code>borrow_global_mut&lt;T&gt;</code>, or <code>borrow_global&lt;T&gt;</code> instruction, or</li>
<li>The body of <code>m::f</code> invokes a function <code>m::g</code> declared in the same module that is annotated with <code>acquires</code></li>
</ul>
<p>For example, the following function inside <code>Counter</code> would need an <code>acquires</code> annotation:</p>
<pre><code class="language-move">// Needs `acquires` because `increment` is annotated with `acquires`
fun call_increment(addr: address): u64 acquires Counter {
    counter::increment(addr)
}
</code></pre>
<p>However, the same function <em>outside</em> <code>Counter</code> would not need an annotation:</p>
<pre><code class="language-move">address 0x43 {
module m {
   use 0x42::counter;

   // Ok. Only need annotation when resource acquired by callee is declared
   // in the same module
   fun call_increment(addr: address): u64 {
       counter::increment(addr)
   }
}
}
</code></pre>
<p>If a function touches multiple resources, it needs multiple <code>acquires</code>:</p>
<pre><code class="language-move=">address 0x42 {
module two_resources {
    struct R1 has key { f: u64 }
    struct R2 has key { g: u64 }

    fun double_acquires(a: address): u64 acquires R1, R2 {
        borrow_global&lt;R1&gt;(a).f + borrow_global&lt;R2&gt;.g
    }
}
}
</code></pre>
<p>The <code>acquires</code> annotation does not take generic type parameters into account:</p>
<pre><code class="language-move=">address 0x42 {
module m {
    struct R&lt;T&gt; has key { t: T }

    // `acquires R`, not `acquires R&lt;T&gt;`
    fun acquire_generic_resource&lt;T: store&gt;(a: addr) acquires R {
        let _ = borrow_global&lt;R&lt;T&gt;&gt;(a);
    }

    // `acquires R`, not `acquires R&lt;u64&gt;
    fun acquire_instantiated_generic_resource(a: addr) acquires R {
        let _ = borrow_global&lt;R&lt;u64&gt;&gt;(a);
    }
}
}
</code></pre>
<p>Finally: redundant <code>acquires</code> are not allowed. Adding this function inside <code>Counter</code> will result in a compilation error:</p>
<pre><code class="language-move">// This code will not compile because the body of the function does not use a global
// storage instruction or invoke a function with `acquires`
fun redundant_acquires_bad() acquires Counter {}
</code></pre>
<p>For more information on <code>acquires</code>, see <a href="./functions.html">Move functions</a>.</p>
<h2 id="reference-safety-for-global-resources"><a class="header" href="#reference-safety-for-global-resources">Reference Safety For Global Resources</a></h2>
<p>Move prohibits returning global references and requires the <code>acquires</code> annotation to prevent dangling references. This allows Move to live up to its promise of static reference safety (i.e., no dangling references, no <code>null</code> or <code>nil</code> dereferences) for all <a href="./references.html">reference</a> types.</p>
<p>This example illustrates how the Move type system uses <code>acquires</code> to prevent a dangling reference:</p>
<pre><code class="language-move=">address 0x42 {
module dangling {
    struct T has key { f: u64 }

    fun borrow_then_remove_bad(a: address) acquires T {
        let t_ref: &amp;mut T = borrow_global_mut&lt;T&gt;(a);
        let t = remove_t(a); // type system complains here
        // t_ref now dangling!
        let uh_oh = *&amp;t_ref.f
    }

    fun remove_t(a: address): T acquires T {
        move_from&lt;T&gt;(a)
    }

}
}
</code></pre>
<p>In this code, line 6 acquires a reference to the <code>T</code> stored at address <code>a</code> in global storage. The callee <code>remove_t</code> then removes the value, which makes <code>t_ref</code> a dangling reference.</p>
<p>Fortunately, this cannot happen because the type system will reject this program. The <code>acquires</code> annotation on <code>remove_t</code> lets the type system know that line 7 is dangerous, without having to recheck or introspect the body of <code>remove_t</code> separately!</p>
<p>The restriction on returning global references prevents a similar, but even more insidious problem:</p>
<pre><code class="language-move=">address 0x42 {
module m1 {
    struct T has key {}

    public fun ret_t_ref(a: address): &amp;T acquires T {
        borrow_global&lt;T&gt;(a) // error! type system complains here
    }

    public fun remove_t(a: address) acquires T {
        let T {} = move_from&lt;T&gt;(a);
    }
}

module m2 {
    fun borrow_then_remove_bad(a: address) {
        let t_ref = m1::ret_t_ref(a);
        let t = m1::remove_t(a); // t_ref now dangling!
    }
}
}
</code></pre>
<p>Line 16 acquires a reference to a global resource <code>m1::T</code>, then line 17 removes that same resource, which makes <code>t_ref</code> dangle. In this case, <code>acquires</code> annotations do not help us because the <code>borrow_then_remove_bad</code> function is outside of the <code>m1</code> module that declares <code>T</code> (recall that <code>acquires</code> annotations can only be used for resources declared in the current module). Instead, the type system avoids this problem by preventing the return of a global reference at line 6.</p>
<p>Fancier type systems that would allow returning global references without sacrificing reference safety are possible, and we may consider them in future iterations of Move. We chose the current design because it strikes a good balance between expressivity, annotation burden, and type system complexity.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="global-storage-structure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="standard-library.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="global-storage-structure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="standard-library.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
